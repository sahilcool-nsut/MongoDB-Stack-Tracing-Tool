# I. MongoDB-Stack-Tracing-Tool
./pythonStackTracing

This Folder contains a tool used to acquire live Stack Traces of a running **MongoDB Server.**
This utility can be useful in **debugging** issues in **real-time** when the server is experiencing high CPU usage due to client queries. 

## Features

The python script is built to run on linux based systems, utilising the **eu-stack** utility of **elfutils** package. and some system commands like **top** 
It further refines the results and can provide:
  1) Individual Stack Trace Reports in **JSON** format
  2) Information regarding individual **thread states, CPU usage, client names etc.**

## Usage

To run the script, provide 2 required parameters as shown below

**Syntax**: 
> python stackTraceTool.py [-n 3 -I 0.5] [-c | -N | -h ]

Options:

 - **n** or **--num-iterations**  : Provide number of iterations for stack (REQUIRED).
 - **I** or **--interval**    :  Provide the INTERVAL between iterations (in seconds) (REQUIRED).
 - **c** or **--cpu-threshold** :     Provide the CPU Usage Threshold for threads (0-100) (OPTIONAL) - Default = 20
 - **N** or **--num-threads** :    Provide the Number of Threads to be taken (>0) (OPTIONAL) - Default = 20
 - **h** or **--help**  :   Show the help menu

The output is stored in **OutputFiles/collectedData.json**

>Potential Issues: 
While running the script without sudo permission, it might ask for sudo password while running the script. After entering it, the results of that iteration may not be meaningful, so it may be required to restart the script.



# II. Eu-Stack Analyzer
./stackReport

This is a tool to provide individual stack reports, particularly aimed for analyzing Running MongoDB servers.

It sets up a flask server which prompts to upload the necessary files, which are
 - **Single iteration of eu-stack**
 > Sample Command
 >
 > sudo eu-stack -p PID > stack>txt
 - **Single iteration of top command**
 > Sample Command
 >
 > top -H -bn1 | grep "conn" > topH.txt
 > 
 > -b for batch mode, -n1 for limiting to 1 iteration. As it is aimed for MongoDB client queries, "conn" named threads are considered (these are MongoDB Clients)

It uses the combination of a **single iteration of eu-stack** and **top** command to provide insights and analysis using different graphs, by rendering a HTML page. This is done using a **python** script.

!["Individual Stack Report Screenshot"](https://github.com/sahilcool-nsut/MongoDB-Stack-Tracing-Tool/blob/main/Screenshots/StackReportScreenshot "Individual Stack Report")

## Features
Provides a HTML page with simple UI showing the following information in form of **graphs/tables**

 - Thread State Distribution
 - Call Stack (Flame Graph)
 - Identical Stack Trace Distribution
 - Top CPU Consuming Threads
 - Most Used Functions
 - Individual Thread Details

## Usage
To locally run the program, follow the steps given below
 - For initial dependency setup, a requirements.txt is provided
 > pip install -r requirements.txt
 - Run the Flask App by running the command
 > python app.py
 > 
 > or
 >
 > flask run
 - Now, the server should be up on localhost:5000
 - !["Upload Files Landing Page"](https://github.com/sahilcool-nsut/MongoDB-Stack-Tracing-Tool/blob/main/Screenshots/UploadScreen.png "Upload Files Landing Page")
 - Go to localhost:5000 and upload the required files. (basic error handling is present to avoid empty files)
 - Press Submit and you will get the results

Current Directory Structure:
 - stackReport
    - data&emsp;&emsp;&emsp;&emsp;&emsp;-> this is the directory where files uploaded are saved.
    - static 
      - graphs&emsp;&emsp;&emsp;&emsp;&emsp; -> graphs generated by script are stored here
      - scripts&emsp;&emsp;&emsp;&emsp;&emsp;-> local JS files
      - styles&emsp;&emsp;&emsp;&emsp;&emsp; -> local CSS files
    - templates &emsp;&emsp;&emsp;&emsp;&emsp;-> Home HTML file, and also where the generated HTML file is stored
    - app.py
    - createStackReport.py
    - README-StackReport.md
    - requirements.txt
    
    
# III. CPU-Intensive Current Ops Extraction
./extractCurrentOp

This is a which returns a JSON file which contains details of the current High CPU-Intensive mongo clients, and what command the threads have hit. 

This is achieved through the use of the top -H command and the db.currentOp() command feature provided by mongosh.

> top -H -bn1 | grep "conn" > topH.txt
>
> mongosh localhost:27017 --eval 'EJSON.stringify(db.currentOp())' --quiet

